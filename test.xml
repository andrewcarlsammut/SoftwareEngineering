<project name="timepack-tests" default="all" basedir=".">  
    <!-- Test related properties -->  
    <property name="src" value="src" />  
    <property name="lib" value="lib" />  
    <property name="classes" value="bin" />  
      
    <!-- Target directory for instrumentation files -->  
    <property name="emma.instr.dir" value="build/tests/instrumentation" />  
      
    <!-- Target directory for coverage files -->  
    <property name="emma.coverage.dir" value="build/tests/coverage" />  
      
    <!-- Classpath for JUnit tests -->  
    <path id="test.classpath">  
        <pathelement path="${src}" />  
        <pathelement path="${test.dir}" />  
        <pathelement path="${demo}" />  
        <pathelement path="${emma.instr.dir}" />  
        <pathelement path="${test.classes}" />  
        <fileset dir="${lib}">  
            <include name="**/*.jar" />  
        </fileset>  
    </path>  
      
    <taskdef resource="emma_ant.properties" classpathref="test.classpath" />  
      
    <!-- Cleans up compilation output  -->  
    <target name="clean-compile-test">  
        <delete dir="${test.classes}" />  
        <delete dir="${emma.instr.dir}" />  
        <delete dir="${emma.coverage.dir}" />  
    </target>  
      
    <!-- Compiles java source code -->  
    <target name="compile-test" depends="clean-compile-test">  
        <mkdir dir="${classes}" />  
        <javac srcdir="${src}" destdir="${classes}">  
            <classpath refid="test.classpath" />  
        </javac>  
    </target>  
      
    <!-- Analyzes the compiled code and adds instrumentation details for testing -->  
    <target name="emma-instrument" depends="compile-test">  
        <mkdir dir="${emma.instr.dir}" />  
        <mkdir dir="${emma.coverage.dir}" />  
        <emma enabled="true">  
            <instr instrpath="${classes}" destdir="${emma.instr.dir}"  
                metadatafile="${emma.coverage.dir}/coverage.emma" merge="true" />  
        </emma>  
    </target>  
      
    <!-- Runs the tests and generates coverage information  -->  
    <target name="test-instrumented" depends="emma-instrument">  
        <junit fork="yes" printsummary="yes" haltonfailure="no">  
            <classpath refid="test.classpath" />  
            <formatter type="plain" usefile="false" />  
            <batchtest>  
                <fileset dir="${classes}" includes="**/*Test.class" />  
            </batchtest>  
            <jvmarg value="-Demma.coverage.out.file=${emma.coverage.dir}/coverage.emma" />  
            <jvmarg value="-Demma.coverage.out.merge=true" />  
        </junit>  
    </target>  
      
    <!-- Create XML reports from the coverage information -->  
    <target name="emma-report" depends="test-instrumented">  
        <emma enabled="true">  
            <report sourcepath="${src}">  
                <fileset dir="${emma.coverage.dir}">  
                    <include name="*.emma" />  
                </fileset>  
                <xml outfile="${emma.coverage.dir}/coverage.xml" />  
            </report>  
        </emma>  
    </target>  
      
    <!-- Default target -->  
    <target name="all" depends="emma-report" />  
      
    <!-- Cleanup -->  
    <target name="clean" depends="clean-compile-test" />  
</project> 